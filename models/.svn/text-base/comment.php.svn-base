<?php
/* SVN FILE:  $Id$ */
/**
 * Short description for file.
 *
 * Long description for file
 *
 * PHP versions 5
 *
 * Licensed under The BSD License
 * Redistributions of files must retain the above copyright notice.
 *
 * @filesource
 * @copyright     Copyright 2007-2009, Felix Ding (http://dingyu.me)
 * @link          http://lonelythinker.org Project LonelyThinker
 * @package       LonelyThinker
 * @author		  $LastChangedBy$
 * @version       $Revision$
 * @modifiedby    $LastChangedBy$
 * @lastmodified  $Date$
 * @license       http://www.opensource.org/licenses/bsd-license.php The BSD License
 */
class Comment extends AppModel
{
    var $name = 'Comment';
	var $belongsTo = array('Post');
    var $validate = array(
       'name' => array('rule'=>'notEmpty', 'message'=>'You forgot to tell us your name'),
       'email' => array('rule'=>'email', 'message'=>"Email is required. Don't worry, it won't be public"),
       'ip' => array('rule'=>'ip', 'message'=>"Well, I don't understand your IP"),
       'body' => array('rule'=>'notEmpty', 'message'=>'Nothing to say?'),
       'post_id' => array('rule'=>'validatePostId', 'message'=>'Hacking attempt!')
   );
   
    /**
     * before delete a comment, save the delete action as a new event
     *
     * @return Boolean true on new event created
     * @date 2009-03-15
     */
    public function beforeDelete()
    {
    	App::import('Model', 'Event');
    	$this->Event = new Event();
    	
    	$comment = $this->read(null, $this->id);
    	$name = 'COMMENT_DELETE_FROM_'.strtoupper($comment['Comment']['status']);
   	
    	$data = array(
    				'name' => $name,
    				'value'=> $this->id,
    				'priority'=> $this->Event->names[$name]
    			);
    	
    	if($this->Event->add($data)) return true;
    	else return false;
    }   
         
	/**
	 * the post with speicific id must exist
	 *
	 */
	public function validatePostId($data)
	{
		return $this->Post->hasAny(array('Post.id'=>$data, 'Post.status'=>'published', 'Post.allow_comment'=>'true'));
	}

	/**
	 * get the resource link of MySQL connection
	*/
	public function getDBOResourceLink()
	{
		return $this->getDataSource()->connection;	
	}
}
?>